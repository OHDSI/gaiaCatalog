{% extends 'base.html' %}
{% block title %}GDSC{% endblock %}
{% block head %}
    {{ super() }}
    <style>
      .btn-link.btn-anchor {
          outline: none !important;
          padding: 0;
          border: 0;
          vertical-align: baseline;
      }
      .btn-link.btn-anchor:focus {
          box-shadow: none !important;
      }
    </style>
{% endblock %}

{% block content %}

      <!-- Collection information -->
      <div class="mb-4">
        <h2 class="mb-1">
          {{ collections[collection]['Title'][0] }}
        </h2>
        <p class="mb-0">
          {% autoescape off %}{{ collections[collection]['Description'][0] }}{% endautoescape %}
        </p>
        {% if collections[collection]['Creator'] and collections[collection]['Creator'][0]|length > 0 %}
        <p class="mb-0 mt-1"><b>Contributors:</b></p>
        {% for contributor in collections[collection]['Creator'][0].split('|') %}
          {% set contributor = contributor.split(';') %}
          <p class="mb-0">
            {{ contributor[0] }}{% if contributor[7] %}, {{ contributor[7] }}{% endif %}{% if contributor[4] %}, <a href="{{ contributor[4] }}" target="_blank">{{ contributor[4] }}</a>{% endif %}
          </p>
        {% endfor %}
        {% endif %}
        {% if collections[collection]['Relations'] %}
        <p class="mb-0 mt-1"><b>Related Content:</b></p>
        {% for relation in collections[collection]['Relations'][0].split('|') %}
          {% set relationship = relation.split(';') %}
          <p class="mb-0">
            The <a href="{{ relationship[2] }}" target="_blank">{{ relationship[0] }}</a> {{ relationship[1].lower() }} this collection.
          </p>
        {% endfor %}
        {% endif %}
        {% if collections[collection]['Coverage'] %}
        <p class="mb-0 mt-1"><b>Geographical coverage:</b></p>
        {% for coverage in collections[collection]['Coverage'][0].split('|') %}
          {% set coverage = coverage.split(';') %}
          <p class="mb-0">
            {% if coverage[1] == 'gazeteer' %}
              <a href="{{ coverage[2] }}" target="_blank">{{ coverage[0] }}</a>
            {% endif %}
          </p>
        {% endfor %}
        {% endif %}
      </div>

      <!-- begin search form and results -->
      <div class="row border rounded p-2">

        <!-- filters -->
        <div class="col-lg-3" style="max-width: 300px;">
          <form method="post" id="filterForm" name="filterForm">
            <div class="container">
              <div class="row mt-3">
                <h5 class="mr-2">Collection: </h5>
              </div>
              <div class="row mb-2">
                <select class="form-control mb-2" id="collection" name="collection">
                  {% for coll in collections %}
                  <option value="{{ collections[coll]['CollectionID'][0] }}" {{ "selected='selected'" if collection == collections[coll]['CollectionID'][0] else "" }}>{{ collections[coll]['Title'][0] }}</option>
                  {% endfor %}
                </select>
              </div>
              <hr>
              <div class="row mt-3 mb-4 mb-lg-2">
                <div class="col-1 mt-1 mx-0 p-0"><input type="checkbox" {{ "checked" if active == 'true' else "" }} id="active" name="active" value="true"></div>
                <div class="col-11 m-0 p-0"><label for="active">show only active datasets</label></div>
              </div>
              <!-- <hr> -->
              <!-- toggle button to collections view -->
              <!-- <div class="row mt-3">
                <a href="{{ switch_url }}" class="btn btn-outline-secondary">
                  {{ switch_label }}
                </a>
              </div> -->
            </div>
          </form>
        </div>

        <div class="col-lg-9 mb-4 container">

          <div class="row d-block d-lg-none border-top"></div>

          <!-- results count and search -->
          {% if results and results|length > 0 %}
          <div class="row mt-2 mb-2 p-2 container-xxl">
            <div class="col-6"><h5 class="ml-2">Results (n={{ numresults }}):</h5></div>
            <div class="col-6 container">
              <form method="post" id="searchForm" name="searchForm">
                <div class="row">
                  <div class="col-md-10 pb-2 pb-md-0">
                    <input type="text" class="form-control" name="searchTerm" placeholder="Enter search term(s)" value="{{ query if (query != "" and query != None) else "" }}">
                  </div>
                  <div class="col-md-2 pt-2 pt-md-0 text-end">
                    <button type="submit" class="btn btn-primary mb-2">Search</button>
                  </div>
                  <input type="hidden" id="collection" name="collection" value="{{ collection }}">
                </div>
                <input type="hidden" id="collection" name="collection" value="{{ collection }}">
              </form>
            </div>
          </div>

          <!-- results -->
          {% for document in results %}
          {% autoescape off %}
          <div class="row mb-2 border rounded p-2 container-xxl"><div class="col-12">

            <!-- title and collections -->
            <div class="row">
              <div class="col-md-7 align-top">
                <h5 class="float-left">
                  {% if document['adms_representationTechnique'] %}
                    {% if document['adms_representationTechnique'][0] == 'raster' %}
                      <img src="/static/raster.jpg" class="mb-1" style="max-width: 18px;">
                    {% else %}
                      {% if document['locn_geometry'] %}
                        <img src="/static/{{ document['locn_geometry'][0] }}.jpg" class="mb-1" style="max-width: 18px;">
                      {% endif %}
                    {% endif %}
                  {% endif %}
                  {% if document['dct_title'] %}
                    <a href="/detail/{{ document['gdsc_tablename'][0] }}?collection={{ collection }}&active={{ active }}&query={{ query }}">{{ document['dct_title'][0] }}</a>
                  {% endif %}
                  <div class="none" style="float: left; display: contents;"><div id="layer-{{ document['gdsc_tablename'][0] }}" class="float-left circle {{ 'green-fill' if document['gdsc_tablename'][0] in loaded_tables or document['gdsc_tileUrl'] else 'red-fill' }}" onclick="javascript:loadlayer('{{ document['gdsc_tablename'][0] }}')"></div></div>
                </h5>
              </div>
              <div class="col-md-5 align-top text-end mb-2">
                {% if document['gdsc_collections'] and document['gdsc_collections']|length > 0 %}
                  <b>Collections:</b> {% for collection in document['gdsc_collections'] %}{{ collection }}{{ " | " if not loop.last else "" }}{% endfor %}
                {% endif %}
              </div>
            </div>

            <!-- source -->
            <div class="row">
              <div class="col-md-9 container ml-2 order-last">
                <div class="row ml-2 pl-2">
                  <div class="col">
                    {% if document['dct_creator'] %}
                      {% for creator in document['dct_creator'] %}
                        {% set creator = creator.split(';') %}
                        {{ creator[0] }}{{ ", " if not loop.last else "" -}}
                      {% endfor -%}
                    {% endif -%}
                    {% if document['dct_issued'] %} ({{ document['dct_issued'][0][:4] }}){% endif %}.
                    {% if document['dct_title'] %}{{ document['dct_title'][0] }}{% endif %} [gis dataset].
                    {% if document['dct_publisher'] %}{{ document['dct_publisher'][0] }}. {% endif %}
                    {% if document['dct_identifier'] %}<a href="{{ document['dct_identifier'][0] }}" class="text-break text-wrap" target="_blank">{{ document['dct_identifier'][0] }}</a>{% endif %}
                  </div>
                </div>
                {% if document['dct_description'] and not "TBD" in document['dct_description'] %}
                <div class="row mt-2">
                  <p class="text-break text-wrap my-0">{{ document['display_description'] }}</p>
                </div>
                {% endif %}
                {% if document['found_in'] %}
                {% if document['found_in']['gdsc_attributes'] and document['found_in']['gdsc_attributes']|length > 0 %}
                <div class="row mt-2"><div class="col"><b>Attributes with <span class="highlight-term">{{ query }}</span>:</b>
                  {% for attr in document['found_in']['gdsc_attributes'] %}{{ attr[0] }}{{ ", " if not loop.last else "" }}{% endfor %}
                  {# { ", ".join([attr[0] for attr in document['found_in']['gdsc_attributes']]) } #}
                </div></div>
                {% endif %}
                {% endif %}
              </div>
              <div class="col-md-3 align-top text-end mt-2i order-first">
                {% if document['dct_modified'] %} <p class="d-block float-right align-top text-right">last updated: {{ document['dct_modified'][0][:10] }}</p> {% endif %}
              </div>
            </div>

            <!-- keywords -->
            <div class="row ml-2 mt-2">
              {% if document['dcat_keyword'] and document['dcat_keyword']|length > 0 %}
              <p><b>key words:</b> {{ ", ".join(document['dcat_keyword']) }}</p>
              {% endif %}
            </div>
          </div></div>
          {% endautoescape %}
          {% endfor %}
          {% endif %}
        </div>

      </div>
      
      <script>
        const collection = document.getElementById("collection");
        collection.addEventListener("change", function() {
         document.getElementById("filterForm").submit();
        });
        const active = document.getElementById("active");
        active.addEventListener("change", function() {
         document.getElementById("filterForm").submit();
        });
        var loadlayer=function(layer_id) {
          console.log('starting with: '+layer_id.toString());
          var status_indicator = document.getElementById('layer-'+layer_id);
          status_indicator.setAttribute('class', 'yin-yang');
          status_indicator.parentElement.setAttribute('class', 'spin');
          $.ajax({
            type: 'POST',
            url: '/loadlayer/' + layer_id,
            success: function (resp) {
                status_indicator.setAttribute('class', 'green-fill circle');
                status_indicator.parentElement.setAttribute('class', 'none'); 
                console.log(resp);
            }});
        }
      </script>
{% endblock %}